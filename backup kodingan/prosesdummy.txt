<link rel="stylesheet" href="dist/css/app.css">
<script src="dist/js/sweetalert2.all.min.js"></script>
<?php

// error_reporting(E_ALL ^ (E_NOTICE | E_WARNING | E_DEPRECATED));
include 'config.php';
session_start();




// if ( $_POST['token'] != $_SESSION['token'] ) {

//  echo "gagl token";

//      exit;
//  }
//   var_dump( $_SESSION ); exit;


// <> proses pendaftaran jalur kerjasama
if ($_GET['PageAction'] == "regist1") {

    session_status() === PHP_SESSION_ACTIVE ?: session_start();
    $token_session = $_SESSION['token'];
    $token_post    = mysqli_real_escape_string($conn, $_POST['token']);
    $nik           = $_SESSION['user_nik'];
    

    if ($token_session === $token_post) {

        $nim                     = mysqli_real_escape_string($conn, $_POST['nim']);
        $id_company              = mysqli_real_escape_string($conn, $_POST['id_company']);
        $start_date              = mysqli_real_escape_string($conn, $_POST['start_date']);
        $end_date                = mysqli_real_escape_string($conn, $_POST['end_date']);
        $internship_period       = mysqli_real_escape_string($conn, $_POST['internship_period']);
        $file1                   = $_FILES['file1']['name'];
        $status_intern           = 'PENDING';
        // $file2                   = $_FILES['file2']['name'];
        // $file2                   = $_FILES['file3']['name'];
        $suffix                  = rand(0000000, 9999999);


        if ($_SESSION['user_nik'] != null) {


            //mengganti nama pdf
            // $tipe_file     = $_FILES['file1']['type']; //mendapatkan mime type
            $nama_baru = "$nim _" . $suffix . ".pdf"; //hasil contoh: file_1.pdf
            $file_temp = $_FILES['file1']['tmp_name']; //data temp yang di upload
            move_uploaded_file($file_temp, "assetfile/" . $nama_baru); //fungsi upload


            //mengganti nama pdf
            // $nama_baru2 = "$nim _" . $suffix . ".pdf"; //hasil contoh: file_1.pdf
            // $file_temp2 = $_FILES['file2']['tmp_name']; //data temp yang di upload
            // move_uploaded_file($file_temp, "assetfile/" . $nama_baru2); //fungsi upload


            //mengganti nama pdf
            // $nama_baru3 = "$nim _" . $suffix . ".pdf"; //hasil contoh: file_1.pdf
            // $file_temp3 = $_FILES['file3']['tmp_name']; //data temp yang di upload
            // move_uploaded_file($file_temp, "assetfile/" . $nama_baru3); //fungsi upload



            $input = $conn->query("INSERT INTO `tb_internship` (`id_internship`, `nim`, `id_company`, `start_date`, `end_date`, `internship_period`, `status_intern`, `file1` ) VALUES (NULL, '$nim', '$id_company', '$start_date', '$end_date', '$internship_period', 'PENDING', '$nama_baru');") or die(mysqli_error($conn));

            if ($input) {
                echo "
                <script type='text/javascript'>
                setTimeout(function () { 
            Swal.fire({
              type: 'success',
              title: 'Penambahan User Berhasil',
              showConfirmButton: false
            });  
                 },10); 
                 window.setTimeout(function(){ 
                  window.location.replace('index.php?page=registration');
                } ,3000); 
                </script>
              ";
            }
        } else {
            echo '<script language="javascript">alert("User Gagal ditambah"); document.location="index.php?page=registration";</script>';
            //echo("Error description: " . $conn -> error);

        }
    } else {
        //echo '<script language="javascript">alert("Error: Data tidak boleh kosong"); document.location="index.php?page=list_peneliti";</script>';
        echo "
                  <script type='text/javascript'>
                   setTimeout(function () { 
              Swal.fire({
                type: 'error',
                title: 'Field data cannot be empty',
                showConfirmButton: false
              });  
                   },10); 
                   window.setTimeout(function(){ 
                    window.location.replace('index.php?page=registration');
                   } ,3000); 
                  </script>
              ";
    }
}
// } else {
//     echo '<script language="javascript">alert("Error: CSRF Protection"); document.location="index.php";</script>';
// }

// </> pendaftaran jalur kerja sama 

// =====================================================================

// <> proses pendaftaran non kerjasama

if ($_GET['PageAction'] == "regist2") {

    session_status() === PHP_SESSION_ACTIVE ?: session_start();
    $token_session = $_SESSION['token'];
    $token_post    = mysqli_real_escape_string($conn, $_POST['token']);
    $nik           = $_SESSION['user_nik'];


    if ($token_session === $token_post) {

        $nim                     = mysqli_real_escape_string($conn, $_POST['nim']);
        $company_name            = mysqli_real_escape_string($conn, $_POST['company_name']);
        $address                 = mysqli_real_escape_string($conn, $_POST['address']);
        $phone                   = mysqli_real_escape_string($conn, $_POST['phone']);
        $start_date              = mysqli_real_escape_string($conn, $_POST['start_date']);
        $end_date                = mysqli_real_escape_string($conn, $_POST['end_date']);
        $description_jobdesc     = mysqli_real_escape_string($conn, $_POST['description_jobdesc']);
        $internship_period       = mysqli_real_escape_string($conn, $_POST['internship_period']);
        $status_intern           = 'PENDING';
        // $file1                   = mysqli_real_escape_string($conn, $_POST['file1']);
        // $file2                   = mysqli_real_escape_string($conn, $_POST['file2']);
        // $file3                   = mysqli_real_escape_string($conn, $_POST['file3']);


        if ($_SESSION) {
            $input_company = $conn->query("INSERT INTO `tb_company` (`id_company`, `company_name`, `address`, `phone`) VALUES (NULL, '$company_name', '$address', '$phone');");
            // $latest = mysqli_insert_id($conn);
            $newcompany = mysqli_query($conn, "SELECT max(id_company) AS id_company_max FROM tb_company");

            $row = mysqli_fetch_array($newcompany);
            $latest = $row['id_company_max'];

            $input = $conn->query("INSERT INTO `tb_internship` (`id_internship`, `nim`, `id_company`, `start_date`, `end_date`, `internship_period`, `description_jobdesc`, `status_intern`) VALUES (NULL, '$nim', '$latest', '$start_date', '$end_date', '$internship_period', '$description_jobdesc', 'PENDING');");

            // if ($input) {
            //     print_r($input);
            // } else {
            //     die(mysqli_error($conn));
            // }
        }
    }
}

// </> pendaftaran non kerjasama

//  ====================================================================

// <> proses pengumpulan logbook

if ($_GET['PageAction'] == "add_log") {

    session_status() === PHP_SESSION_ACTIVE ?: session_start();
    $token_session = $_SESSION['token'];
    $token_post    = mysqli_real_escape_string($conn, $_POST['token']);

    if ($token_session === $token_post) {

        $id_logbook              = mysqli_real_escape_string($conn, $_POST['id_logbook']);
        $id_internship           = mysqli_real_escape_string($conn, $_POST['id_internship']);
        $nim                     = mysqli_real_escape_string($conn, $_POST['nim']);
        $start_date              = mysqli_real_escape_string($conn, $_POST['start_date']);
        $end_date                = mysqli_real_escape_string($conn, $_POST['end_date']);
        $week_num                = mysqli_real_escape_string($conn, $_POST['week_num']);
        $description             = mysqli_real_escape_string($conn, $_POST['description']);
        // $filelogbook             = $_FILES['file1']['name'];
        // $suffix                  = rand(0000000, 9999999);

        if ($_SESSION) {
            $input = $conn->query("INSERT INTO `tb_logbook` (`id_logbook`, `id_internship`, `nim`, `startdate`, `enddate`, `week_num`, `description`) VALUES ('', '$id_internship', '$nim', '$start_date', '$end_date', '$week_num', '$description');") or die(mysqli_error($conn));
        }
    }
}

// </> pengumpulan logbook

//  ====================================================================


// <> proses absensi


if ($_GET['PageAction'] == "attendance") {

    session_status() === PHP_SESSION_ACTIVE ?: session_start();
    $token_session = $_SESSION['token'];
    $token_post    = mysqli_real_escape_string($conn, $_POST['token']);

    if ($token_session === $token_post) {

        $id_attendance           = mysqli_real_escape_string($conn, $_POST['id_attendance']);
        $id_internship           = mysqli_real_escape_string($conn, $_POST['id_internship']);
        $nim                     = mysqli_real_escape_string($conn, $_POST['nim']);
        $type_attendance             = mysqli_real_escape_string($conn, $_POST['type_attendance']);
        $week               = mysqli_real_escape_string($conn, $_POST['week']);
        $notes             = mysqli_real_escape_string($conn, $_POST['notes']);
        $check_in                 = date("Y-m-d H:i:s");
        // $filelogbook             = $_FILES['file1']['name'];
        // $suffix                  = rand(0000000, 9999999);
        // $status                  = mysqli_real_escape_string($conn, $_POST['status']);

        if ($_SESSION) {
            $input = $conn->query("INSERT INTO `tb_attendance` (`id_attendance`, `id_internship`, `nim`, `type_attendance`, `notes`, `week`, `check_in` ) VALUES ('', '$id_internship', '$nim', '$type_attendance', '$notes', '$week', '$check_in');") or die(mysqli_error($conn));
        }
    }
}
// </> proses absensi

// ====================================================================


// <> proses final report

if ($_GET['PageAction'] == "finalreport") {

    session_start();
    $token_session = $_SESSION['token'];
    $token_post    = mysqli_real_escape_string($conn, $_POST['token']);
    $nik           = $_SESSION['user_nik'];
    $tipe_file     = $_FILES['finalreport']['type']; //mendapatkan mime type
    mime_content_type($_FILES['finalreport']['tmp_name']);

    if ($token_session === $token_post) {

        // $id_intership                  = mysqli_real_escape_string($conn, $_POST['id_internship']);
        // $finalreport_date              = mysqli_real_escape_string($conn, $_POST['finalreport_date']);
        $finalreport                   = $_FILES['finalreport']['name'];
        $suffix                        = rand(0000000, 9999999);


        if ($_SESSION['user_nik'] != null) {

            // var_dump( $_SESSION ); exit;

            $nim = $_SESSION['user_nik'];


            //mengganti nama pdf
            $nama_baru = "$nik _" . $suffix . ".pdf"; //hasil contoh: file_1.pdf
            $file_temp = $_FILES['finalreport']['tmp_name']; //data temp yang di upload

            move_uploaded_file($file_temp, "file_finalreport/" . $nama_baru); //fungsi upload

            $tambah_finalreport = $conn->query("UPDATE `tb_internship` SET 
            `date_finalreport` = CURRENT_TIMESTAMP(), `final_report` =  '$nama_baru' WHERE `nim` = $nim ;");




            if ($tambah_finalreport === true) {
                echo "
                <script type='text/javascript'>
                setTimeout(function () { 
            Swal.fire({
              type: 'success',
              title: 'Penambahan User Berhasil',
              showConfirmButton: false
            });  
                 },10); 
                 window.setTimeout(function(){ 
                  window.location.replace('index.php?page=registration');
                } ,3000); 
                </script>
              ";
            }
        } else {
            echo '<script language="javascript">alert("User Gagal ditambah"); document.location="index.php?page=registration";</script>';
            //echo("Error description: " . $conn -> error);

        }
    } else {
        //echo '<script language="javascript">alert("Error: Data tidak boleh kosong"); document.location="index.php?page=list_peneliti";</script>';
        echo "
                  <script type='text/javascript'>
                   setTimeout(function () { 
              Swal.fire({
                type: 'error',
                title: 'Field data cannot be empty',
                showConfirmButton: false
              });  
                   },10); 
                   window.setTimeout(function(){ 
                    window.location.replace('index.php?page=registration');
                   } ,3000); 
                  </script>
              ";
    }
}
// } else {
//     echo '<script language="javascript">alert("Error: CSRF Protection"); document.location="index.php";</script>';
// }


// home, data magang


?>